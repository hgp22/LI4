@page "/perfil"
@using Controllers
@using Authentication
@inject IUserController userController
@inject AuthenticationStateProvider authStateProvider
@attribute [Authorize(Roles = "Administrator,User")]
<h3>Perfil</h3>
<h2>Olá, @username</h2>

<div>
    <h4>Método de Pagamento</h4>
    <label>
        <input type="radio" name="metodoPagamento" value="1" checked="@UserMetodoPagamento(1)" @onclick="() => SelecionarMetodoPagamento(1)" />
        MBWAY
    </label>
    <label>
        <input type="radio" name="metodoPagamento" value="2" checked="@UserMetodoPagamento(2)" @onclick="() => SelecionarMetodoPagamento(2)" />
        PAYPAL
    </label>
    <label>
        <input type="radio" name="metodoPagamento" value="3" checked="@UserMetodoPagamento(3)" @onclick="() => SelecionarMetodoPagamento(3)" />
        VISA
    </label>
    <label>
        <input type="radio" name="metodoPagamento" value="4" checked="@UserMetodoPagamento(4)" @onclick="() => SelecionarMetodoPagamento(4)" />
        MULTIBANCO
    </label>

    <h4>Detalhes de Entrega</h4>
    <label>
        <input type="radio" name="detalhesEntrega" value="1" checked="@UserDetalhesEntrega(1)" @onclick="() => SelecionarDetalhesEntrega(1)" />
        Entrega em Casa
    </label>
    <label>
        <input type="radio" name="detalhesEntrega" value="2" checked="@UserDetalhesEntrega(2)" @onclick="() => SelecionarDetalhesEntrega(2)" />
        Levantamento na Loja
    </label>
</div>

<div>
    <h4>Alterar Detalhes do Perfil</h4>

    <div>
        <label for="passwordAntiga">Palavra-passe Antiga:</label>
        <input type="password" id="passwordAntiga" />
    </div>
    <div>
        <label for="novaPassword">Nova Palavra-passe:</label>
        <input type="password" id="novaPassword" />
    </div>

    <div>
        <label for="emailAntigo">Email Antigo:</label>
        <input type="email" id="emailAntigo" />
    </div>
    <div>
        <label for="novoEmail">Novo Email:</label>
        <input type="email" id="novoEmail" />
    </div>

    <button @onclick="AlterarDetalhes">Salvar Alterações</button>
</div>

@code {
    private string username { get; set; }
    private CustomAuthenticationStateProvider customAuthStateProvider { get; set; }
    private UserAccount user { get; set; }

    private async Task InitializeAsync()
    {
        customAuthStateProvider = (CustomAuthenticationStateProvider)authStateProvider;
        username = (await customAuthStateProvider.GetAuthenticationStateAsync()).User.Identity.Name;
        user = userController.GetByUsername(username);
    }

    protected override async Task OnInitializedAsync()
    {
        await InitializeAsync();
    }

    private bool UserMetodoPagamento(int metodo)
    {
        if (user != null)
        {
            return user.MetodoPagamento == metodo;
        }
        return false;
    }

    private bool UserDetalhesEntrega(int detalhes)
    {
        if (user != null)
        {
            return user.DetalhesEntrega == detalhes;
        }
        return false;
    }

    private void SelecionarMetodoPagamento(int metodo)
    {
        if (user != null)
        {
            user.MetodoPagamento = metodo;
            userController.Update(user);
            StateHasChanged();
        }
    }

    private void SelecionarDetalhesEntrega(int detalhes)
    {
        if (user != null)
        {
            user.DetalhesEntrega = detalhes;
            userController.Update(user);
            StateHasChanged();
        }
    }

    private void AlterarDetalhes()
    {
        // por fazer
    }
}
